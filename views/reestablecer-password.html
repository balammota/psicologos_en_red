<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nueva Contrase√±a - Psic√≥logos en Red</title>
    <link rel="stylesheet" href="/estilos.css">
    <style>
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .modal-overlay.activo { display: flex; }
        .modal-box {
            background: white;
            border-radius: 16px;
            padding: 28px;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            border-top: 6px solid var(--primario-rosa);
        }
        .modal-box h3 { margin: 0 0 12px 0; color: var(--primario-rosa); font-size: 1.25rem; }
        .modal-box p { color: #555; margin: 0 0 16px 0; font-size: 0.95rem; }
        .modal-box .btn-row { display: flex; justify-content: flex-end; margin-top: 16px; }
        .modal-box .btn-modal {
            padding: 12px 24px;
            border-radius: 10px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            background: var(--primario-rosa);
            color: white;
            font-size: 0.95rem;
        }
        .modal-box .btn-modal:hover { opacity: 0.9; }
        .modal-msg .icon { font-size: 2.5rem; margin-bottom: 12px; }
    </style>
</head>
<body class="auth-body" style="background: var(--fondo-hueso); display: flex; justify-content: center; align-items: center; height: 100vh;">
    <div class="auth-card" style="width: 100%; max-width: 400px; padding: 30px; border-top: 8px solid var(--primario-rosa);">
        <h2 style="color: var(--primario-rosa);">Crear nueva contrase√±a</h2>
        <p>Ingresa tu nueva clave de acceso.</p>
        
        <form id="form-reset" style="margin-top: 20px;">
            <div class="form-group">
                <label style="font-weight: bold; color: var(--primario-rosa);">Nueva Contrase√±a</label>
                <input type="password" id="new-password" placeholder="M√≠nimo 6 caracteres" required 
                       style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--suave-arena);">
            </div>
            <button type="submit" class="btn-auth" 
                    style="background: var(--primario-rosa); color: white; width: 100%; padding: 15px; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; margin-top: 15px;">
                Actualizar Contrase√±a
            </button>
        </form>
    </div>

    <!-- Modal: notificaciones -->
    <div id="modal-msg" class="modal-overlay" onclick="if(event.target===this) cerrarModal();">
        <div class="modal-box modal-msg">
            <div class="icon" id="modal-icon">üìß</div>
            <h3 id="modal-titulo">Mensaje</h3>
            <p id="modal-texto"></p>
            <div class="btn-row">
                <button type="button" class="btn-modal" id="modal-btn-ok">Entendido</button>
            </div>
        </div>
    </div>

    <script>
        function mostrarModal(titulo, texto, icono, irALogin) {
            document.getElementById('modal-titulo').textContent = titulo || 'Mensaje';
            document.getElementById('modal-texto').textContent = texto || '';
            document.getElementById('modal-icon').textContent = icono || 'üìß';
            document.getElementById('modal-msg').classList.add('activo');
            const btn = document.getElementById('modal-btn-ok');
            btn.onclick = function() {
                cerrarModal();
                if (irALogin) window.location.href = '/login';
            };
        }
        function cerrarModal() {
            document.getElementById('modal-msg').classList.remove('activo');
        }

        document.getElementById('form-reset').onsubmit = async (e) => {
            e.preventDefault();
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            const password = document.getElementById('new-password').value;

            if (!token) {
                mostrarModal('Enlace inv√°lido', 'Solicita uno nuevo desde el login.', '‚ùå', true);
                return;
            }

            if (password.length < 6) {
                mostrarModal('Contrase√±a corta', 'La contrase√±a debe tener al menos 6 caracteres.', '‚ö†Ô∏è', false);
                return;
            }

            const res = await fetch('/auth/update-password-forgotten', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ token, password })
            });

            const data = await res.json().catch(() => ({}));

            if (res.ok && data.success) {
                mostrarModal('¬°Listo!', 'Contrase√±a actualizada con √©xito. Ahora puedes iniciar sesi√≥n.', '‚úÖ', true);
            } else {
                mostrarModal('Error', data.error || 'El enlace pudo haber expirado. Solicita uno nuevo desde el login.', '‚ùå', true);
            }
        };
    </script>
</body>
</html>